name: 2. Automatic Patch Release
permissions: write-all
on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch:
    inputs:
      retry_count:
        description: 'Do not change value below'
        required: false
        default: '1'
jobs:
  check:
    name: Check new patch
    runs-on: ubuntu-latest
    env:
      repository: ${{ github.repository }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4.1.1
      - name: Check github connection
        id: check-gh
        run: bash src/etc/connection.sh
      - name: Check new patch ReVanced
        id: check-rv
        if: steps.check-gh.outputs.internet_error == '0'
        run: bash src/etc/ci.sh ReVanced/revanced-patches latest youtube-revanced.apk

      - name: Check new patch ReVanced LisoUseInAIKyrios
        id: check-rv-liso
        if: steps.check-gh.outputs.internet_error == '0'
        run: bash src/etc/ci.sh ReVanced/revanced-patches latest youtube-revanced-LisoUseInAIKyrios.apk
      - name: Check new patch Revanced Extended forked by Anddea Stable Version
        id: check-rve-anddea-stable
        if: steps.check-gh.outputs.internet_error == '0'
        run: bash src/etc/ci.sh anddea/revanced-patches latest youtube-stable-anddea.apk

      - name: Check new patch Revanced Extended
        id: check-rve
        if: steps.check-gh.outputs.internet_error == '0'
        run: bash src/etc/ci.sh inotia00/revanced-patches latest youtube-revanced-extended.apk

      - name: Check new patch Revanced Extended Arsclib
        id: check-rve-arsclib
        if: steps.check-gh.outputs.internet_error == '0'
        run: bash src/etc/ci.sh inotia00/revanced-patches-arsclib latest reddit-revanced-extended-arsclib.apk
      - name: Check new patch Twitter Piko Stable
        id: check-twitter-piko-stable
        if: steps.check-gh.outputs.internet_error == '0'
        run: bash src/etc/ci.sh crimera/piko latest twitter-stable-piko.apk

 
      - name: Re-run workflow if github connection not stable
        if: always() && steps.check-rv.outcome == 'skipped' && env.retry_count < env.max_retries
        uses: actions/github-script@v7
        with:
          script: |
            const maxRetries = ${{ env.max_retries }};
            let retryCount = ${{ env.retry_count }};
            if (retryCount < maxRetries) {
              retryCount += 1;
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: "ci.yml",
                ref: context.ref,
                inputs: {
                  'retry_count': String(retryCount)
                }
              });
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          retry_count: ${{ github.event.inputs.retry_count }}
          max_retries: 3
      - name: Set Release Tag
        id: tag
        run: echo "release_tag=v$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT
    outputs:
      check_rv: ${{ steps.check-rv.outputs.new_patch }}
      check_rv_liso: ${{ steps.check-rv-liso.outputs.new_patch }}
      check_rve_anddea_stable: ${{ steps.check-rve-anddea-stable.outputs.new_patch }}
      check_rve: ${{ steps.check-rve.outputs.new_patch }}
      check_rve_arsclib: ${{ steps.check-rve-arsclib.outputs.new_patch }}
      check_twitter_piko_stable: ${{ steps.check-twitter-piko-stable.outputs.new_patch }}

      release_tag: ${{ steps.tag.outputs.release_tag }}

  Patch-Revanced:
    name: Patch Revanced Stable
    needs: check
    if: ${{ needs.check.outputs.check_rv == 1 }}
    uses: ./.github/workflows/manual-patch.yml
    with:
      org: "Revanced"
      release_tag: ${{ needs.check.outputs.release_tag }}
      skip_release: true

  Patch-Revanced-Liso:
    name: Patch Revanced LisoUseInAIKyrios
    needs: check
    if: ${{ needs.check.outputs.check_rv_liso == 1 }}
    uses: ./.github/workflows/manual-patch.yml
    with:
      org: "Revanced LisoUseInAIKyrios"
      release_tag: ${{ needs.check.outputs.release_tag }}
      skip_release: true
  Patch-RVE-anddea-stable:
    name: Patch RVX Anddea Stable
    needs: check
    if: ${{ needs.check.outputs.check_rve_anddea_stable == 1 }}
    uses: ./.github/workflows/manual-patch.yml
    with:
      org: "RVE-anddea-stable"
      release_tag: ${{ needs.check.outputs.release_tag }}
      skip_release: true

  Patch-RVE:
    name: Patch Revanced Extended Stable
    needs: check
    if: ${{ needs.check.outputs.check_rve == 1 }}
    uses: ./.github/workflows/manual-patch.yml
    with:
      org: "Revanced Extended"
      release_tag: ${{ needs.check.outputs.release_tag }}
      skip_release: true

  Patch-RVE-Arsclib:
    name: Patch Revanced Extended Arsclib
    needs: check
    if: ${{ needs.check.outputs.check_rve_arsclib == 1 }}
    uses: ./.github/workflows/manual-patch.yml
    with:
      org: "Revanced Extended Arsclib"
      release_tag: ${{ needs.check.outputs.release_tag }}
      skip_release: true

  Patch-Twitter-Piko-Stable:
    name: Patch Twitter Piko Stable
    needs: check
    if: ${{ needs.check.outputs.check_twitter_piko_stable == 1 }}
    uses: ./.github/workflows/manual-patch.yml
    with:
      org: "Twitter Piko Stable"
      release_tag: ${{ needs.check.outputs.release_tag }}
      skip_release: true

  Release_All:
    name: Release All Patched Apps
    needs: [check, Patch-Revanced, Patch-Revanced-Liso, Patch-RVE-anddea-stable, Patch-RVE, Patch-RVE-Arsclib, Patch-Twitter-Piko-Stable]
    if: |
      always() && 
      (needs.check.outputs.check_rv == 1 || 
       needs.check.outputs.check_rv_liso == 1 || 
       needs.check.outputs.check_rve_anddea_stable == 1 || 
       needs.check.outputs.check_rve == 1 || 
       needs.check.outputs.check_rve_arsclib == 1 || 
       needs.check.outputs.check_twitter_piko_stable == 1)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4.2.2
        
      - name: Download Release Note Fragments
        uses: actions/download-artifact@v4
        with:
          pattern: notes-*
          path: release_notes_fragments
          merge-multiple: false

      - name: Combine Release Notes
        run: |
          echo "Built using the latest available patches and CLI tools." > release_notes.md
          echo -e "\nCheck [Readme.md](../main/README.md) for details and installation instructions." >> release_notes.md
          echo -e "\n" >> release_notes.md
          
          for file in release_notes_fragments/*/release_notes.md; do
            if [ -f "$file" ]; then
              cat "$file" >> release_notes.md
              echo -e "\n\n" >> release_notes.md
            fi
          done
          
          cat release_notes.md

      - name: Download Artifacts (Explicit)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: "revanced-stable-*"
          path: ./release
          merge-multiple: true

      - name: Download Artifacts (Liso)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: "revanced-liso-*"
          path: ./release
          merge-multiple: true

      - name: Download Artifacts (Anddea)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: Cache_anddea_stable
          path: ./release

      - name: Download Artifacts (RVE)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: Cache_rve
          path: ./release

      - name: Download Artifacts (Arsclib)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: Cache_rve_arsclib
          path: ./release

      - name: Download Artifacts (Piko)
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: Cache_twitter_piko
          path: ./release

      - name: Releasing APK files
        uses: ./.github/actions/release
        with:
          tag_name: ${{ needs.check.outputs.release_tag }}
          release_notes: release_notes.md
          prerelease: false




